<html>

<head>
    <title>campo minato</title>
    <link rel="stylesheet" href="Styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <script>

        class Cella {
            constructor(mina) {
                this.mina = mina;       //indica se nella cella è presente una mina
                this.aperta = false;    //indica se la cella è stata aperta
                this.cont = 0;          //indica quante mine limitrofe ha la cella
                this.flag = false;      //indica se sulla cella è stata messa una bandierina
            }
        }

        //impostazioni del campo
        let n = 10;
        let mine = 10;
        let campo = [];
        let cAperte = 0;
        let gioco = true;
        let bandiere = 0;

        function generaCampo() {
            //creazione delle celle
            for (let r = 0; r < n; r++) {

                campo[r] = [];

                for (let c = 0; c < n; c++) {

                    campo[r][c] = new Cella(false);
                    $('#griglia').append('<div class="cella" data-row="' + r + '" data-col="' + c + '"></div>');

                }
                $('#griglia').append('<br>');


            }

            //assegnazione delle mine nel campo
            for (let m = 0; m < mine; m++) {
                let posRiga = Math.floor(Math.random() * n);
                let posCol = Math.floor(Math.random() * n);

                if (campo[posRiga][posCol].mina == false) {


                    campo[posRiga][posCol].mina = true;



                    //incremento del valore delle celle adiacenti
                    for (let i = -1; i <= 1; i++) {

                        for (let j = -1; j <= 1; j++) {
                            let rigaAdiacente = posRiga + i;
                            let colAdiacente = posCol + j;

                            if (rigaAdiacente >= 0 && colAdiacente >= 0 && rigaAdiacente < n && colAdiacente < n) {
                                campo[rigaAdiacente][colAdiacente].cont++;
                            }
                        }
                    }

                }

            }
        }

        function scopriMine() {

            for (let r = 0; r < n; r++) {

                for (let c = 0; c < n; c++) {

                    if (campo[r][c].mina == true) {

                        campo[r][c].aperta = true;
                        //$('.cella[data-row=' + r + '][data-col=' + c + ']').html('<i class="fa fa-bomb"></i>')
                        $('.cella[data-row=' + r + '][data-col=' + c + ']').addClass("mina");

                    }
                }

            }
            gioco = false;

        }

        function controlla(r, c) {

            if (campo[r][c].aperta == true) {
                return true;
            }

            campo[r][c].aperta = true;
            $('.cella[data-row=' + r + '][data-col=' + c + ']').addClass("aperta");
            cAperte++;

            if ((campo[r][c].mina == false) && (campo[r][c].cont == 0)) {

                for (let dr = r - 1; dr <= r + 1; dr++) {
                    for (let dc = c - 1; dc <= c + 1; dc++) {
                        // Controllo se la cella adiacente è all'interno del campo di gioco
                        if (dc >= 0 && dr >= 0 && dc < n && dr < n) {
                            // Controllo se la cella adiacente non è stata ancora aperta
                            if (campo[dr][dc].aperta == false) {

                                // Richiamo la funzione controlla per aprire la cella adiacente e controllare i suoi vicini
                                controlla(dr, dc);
                            }
                        }
                    }
                }
            }

            if ((campo[r][c].mina == false) && (campo[r][c].cont > 0)) {
                $('.cella[data-row=' + r + '][data-col=' + c + ']').addClass("aperta");

                if (campo[r][c].cont > 0) {
                    $('.cella[data-row=' + r + '][data-col=' + c + ']').html(campo[r][c].cont);

                    $('.cella[data-row=' + r + '][data-col=' + c + ']').addClass("colore-" + (campo[r][c].cont < 4 ? campo[r][c].cont : 4));
                }
            }

            if (campo[r][c].mina == true) {
                gioco = false;
                scopriMine();
                alert("hai perso");
            }

        }


        $(document).ready(function () {


            generaCampo();


            //quando clicco su una cella
            $('.cella').click(function () {

                if (gioco == true) {

                    var r = parseInt($(this).attr("data-row"));
                    var c = parseInt($(this).attr("data-col"));

                    if ((gioco == true) && (campo[r][c].flag == false)) {


                        controlla(r, c);

                    }
                }
                else {
                    alert("il gioco è terminato");
                }


            });


            $('.cella').bind('contextmenu', function (e) {


                e.preventDefault();
                if (bandiere < mine) {


                    
                    var r = parseInt($(this).attr("data-row"));
                    var c = parseInt($(this).attr("data-col"));

                    if ((gioco == true) && (campo[r][c].aperta == false) && (campo[r][c].flag == false)) {

                        bandiere++;
                        campo[r][c].flag = true;
                        $('.cella[data-row=' + r + '][data-col=' + c + ']').addClass("flag");

                    }

                    
                }


            });

            $('.flag').bind('contextmenu', function (e) {

                alert("ciao");
                e.preventDefault();
                var r = parseInt($(this).attr("data-row"));
                var c = parseInt($(this).attr("data-col"));

                campo[r][c].flag = false;
                $('.cella[data-row=' + r + '][data-col=' + c + ']').removeClass("flag");
                $('.cella[data-row=' + r + '][data-col=' + c + ']').addClass("cella");

            });



        });





    </script>
</head>

<body>

    <br>
    <h1>CAMPO MINATO</h1>

    <div id="griglia"></div>

    <button onclick="scopriMine();">scopri</button>

    <a href="../finestra_teoria.html"><img src="../img/freccia.png" style="width:100px;height:100px;"></a>

</body>

</html>
